# Shell 脚本编程 05

- `awk` 应用
- [综合案例](#综合案例)

## awk 基本用法

- [`awk` 命令解析](#awk-命令解析)
  - awk 工具概述
  - 命令格式解析
  - awk 内置变量
  - awk 过滤的时机
- [`awk` 处理条件](#awk-处理条件)
  - 处理条件概述
  - 条件设置示例
  - 多个条件的组合
  - 变量的运算

### `awk` 命令解析

#### `awk` 工具概述

- `awk` 编程语言/数据处理引擎
  - 创造者：*Aho*、*Weinberger*、*Kernighan*
  - 基于模式匹配检查输入文本，逐行处理并输出
  - 通常用在 Shell 脚本中，获取指定的数据
  - 单独使用时，可对文本数据做统计

#### 命令格式解析

- 主要用法
  - 格式1：`前置命令 | awk [选项] '[条件]{指令}'`
  - 格式2：`awk [选项] '[条件]{指令}' 文件 ...`
    - 多条语句可以分号分隔，`print` 是最常用的指令

  ```bash
  awk '{print $1,$3}' test.txt
  ```

- 常用命令选项
  - `-F` 指定分隔符，可省略（默认空格或 Tab 位），多个分隔符可以用中括号（`[]`）括起来

  ```bash
  awk -F: '{print $1,$3}' /etc/passwd
  ```

  ```bash
  # 检查登录失败的 IP 地址有哪些
  awk '/Failed/{print $11}' /var/log/secure

  # 检查内存的剩余容量
  free -h | awk '/^Mem/{print $4}'

  # 过滤网络流量
  ifconfig eth0 | awk '/RX p/{print $6$7}'
  ```

#### `awk` 内置变量

- 有特殊含义，可直接使用

  |      | 用途                                                   |
  | ---- | ------------------------------------------------------ |
  | `FS` | 保存或设置字段分隔符，例如 FS= “:”，与 `-F` 功能一样   |
  | `$n` | 指定分隔的第 n 个字段，如 $1、$3 分别表示第 1、第 3 列 |
  | `$0` | 当前读入的整行文本内容                                 |
  | `NF` | 记录当前处理行的字段个数（列数）                       |
  | `NR` | 记录当前已读入行的数量（行数）                         |

  ```bash
  awk -F: '{print NR,NF}' /etc/passwd

  awk -F: '{print $NF}' /etc/passwd # 输出每行最后一个字段

  awk -F: '{print "用户名:",$1,"\n\t解释器:",$7,"\n"}' /etc/passwd
  ```

#### `awk` 过滤的时机

- 在所有行前处理，`BEGIN{ }`
  - 读入第一行文本之前执行
  - 一般用来初始化操作
- 逐行处理，`{ }`
  - 逐行读入文本执行相应的处理
  - 是最常见的编辑指令块
- 在所有行后处理，`END{ }`
  - 处理完最后一行文本之后执行
  - 一般用来输出处理结果
- **以上处理方式可以单独使用，也可以同时一起使用**

```bash
awk 'BEGIN{a=34;print a+12}' # 预处理不需要数据文件
awk 'BEGIN{x=0}/\<bash$/{x++}END{print x}' /etc/passwd # 统计使用 bash 的用户个数
awk 'BEGIN{print NR}END{print NR}' m.txt
# 预处理时，行数为 0；
# 全部处理完成以后，行数为已读入文本的行数
```

### `awk` 处理条件

#### 处理条件概述

- 所有的行全部处理并输出吗？
- 怎么限制处理的条件？
- 根据多个条件来处理指定的行？
- 格式回顾
  - `awk [选项] '[条件]{编辑指令}' 文件 ...`
- 条件的表现形式？
  - 正则表达式
  - 数值/字符串比较
  - 逻辑比较
  - 运算符

#### 条件设置示例

- 正则表达式
  - `/正则表达式/`
  - `~` 匹配、`!~` 不匹配
  
  ```bash
  awk -F: '/^ro/{print}' /etc/passwd

  awk -F: '$7!~/bash$/{print $1,$7}' /etc/passwd # 列出第七个字段不以 bash 结尾的用户名、登录 Shell
  ```

- 数值比较
  - `==` 等于、`!=` 不等于
  - `>` 大于、`>=` 大于或等于
  - `<` 小于、`<=` 小于或等于

  ```bash
  awk 'NR==2{print}' reg.txt
  awk '$2!="XX"{print}' reg.txt
  awk 'NF>=2{print}' reg.txt
  ```

#### 多个条件的组合

- 逻辑比较测试
  - `&&` 逻辑与：期望多个条件都成立
  - `||` 逻辑或：只要有一个条件成立即满足要求
  
  ```bash
  awk -F: '$3>=0&&$3<2{print $1,$3}' /etc/passwd # 列出 UID 小于 2 的用户信息

  awk -F: '$3==1||$3==7{print $1,$3}' /etc/passwd # 列出 UID 为 1 或 7 的用户信息
  ```

#### 变量的运算

- 运算符
  - `+`、`-`、`*`、`/`、`%`
  - `++`、`--`、`+=`、`-=`、`*=`、`/=`
  
  ```bash
  awk 'NR%2==1{print}' reg.txt

  awk 'BEGIN{i=0}{i+=NF}END{print i}' reg.txt

  seq 200 | awk 'BEGIN{i=0}($0%3==0)&&($0%13==0){i++}END{print i}' # seq 生成 0 到 200 的数组
  ```

## `awk` 高级应用

- [`awk` 数组](#awk-数组)
  - 数组的定义及使用
  - `awk` 数组的经典应用
- [`awk` 案例分析](#awk-案例分析)
  - 任务需求
  - 思路讲解及分析

### `awk` 数组

#### 数组的定义及应用

- 定义数组
  - 格式：`数组名[下标]=元素值`
- 调用数组
  - 格式：`数组名[下标]`
- 遍历数组
  - 用法：`for(变量 in 数组名){print 数组名[变量]}`
- 示例

  ```bash
  # 为数组 name 赋值两个元素，值分别为 jim、tom
  awk 'BEGIN{name[0]="jim";name[1]="tom";print name[0],name[1]}'
  ```

### `awk` 案例分析

#### 任务需求

- 

## 综合案例
