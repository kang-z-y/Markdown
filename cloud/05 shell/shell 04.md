# Shell 脚本编程 04

- [正则表达式](#正则表达式)
- [sed 基本用法](#sed-基本用法)
- [sed 文本块处理](#sed-文本块处理)

## 正则表达式

- [正则表达式概述](#正则表达式概述)
  - 什么是正则表达式
  - egrep 过滤工具
- [基本元字符](#基本元字符)
  - 行首尾及单字匹配
  - 未定匹配次数
  - `{}` 限定次数
- [其他元字符](#其他元字符)
  - `[]` 范围内单字匹配
  - 整体及边界匹配

### 正则表达式概述

- Regular Express
  - 使用“一串符号”来描述有共同属性的数据

- egrep 过滤工具
  - 文本处理顺序
    - 以行为单位，逐行进行处理
    - 默认只输出与表达式相匹配的文本行
  - 基本用法
    - 格式1：`egrep [选项] '正则表达式' 文件...`
    - 格式2：`前置命令 | egrep [选项] '正则表达式'`
- 常用命令选项
  - `-i`：忽略字母大小写
  - `-v`：条件取反
  - `-c`：统计匹配的行数
  - `-q`：静默、无任何输出，一般用于检测[^1]
  - `-n`：显示出匹配结果所在的行号
  - `--color`：标红显示匹配字串

[^1]:看 `$?` 返回值，如果为 0，说明有匹配，否则无匹配

- 基本正则列表
  <div align=center> <img alt="基本正则列表" title="" src=https://kkkkzzzzyy.oss-cn-beijing.aliyuncs.com/云计算/基本正则表.png width=100%/> </div>
- 扩展正则列表
  <div align=center> <img alt="扩展正则列表" title="扩正则列表" src=https://kkkkzzzzyy.oss-cn-beijing.aliyuncs.com/云计算/扩展正则表.png width=100%/> </div>

### 基本元字符

- 行首尾及单字匹配

  | 类型 | 含义     | 示例 | 说明                             |
  | ---- | -------- | ---- | -------------------------------- |
  | ^    | 匹配行首 | ^abc | 以 abc 开头的行                  |
  | \$   | 匹配行尾 | ^\$  | 空行                             |
  | .    | 单个字符 | .    | 除换行符（\n）以外的任意单个字符 |

- 未定匹配次数

  | 类型 | 含义         | 示例   | 说明                 |
  | ---- | ------------ | ------ | -------------------- |
  | +    | 最少匹配一次 | (abc)+ | 一个或多个连续的 abc |
  | ?    | 最多匹配一次 | a?     | 0 个或 1 个 a        |
  | \*   | 匹配任意次数 | .\*    | 任意长度的任意字符串 |

- 限定次数

  | 类型  | 含义          | 示例      | 说明                     |
  | ----- | ------------- | --------- | ------------------------ |
  | {n}   | 匹配 n 次     | (ab){3}   | 匹配 ababab              |
  | {n,m} | 匹配 n-m 次   | (ab){1,3} | 匹配 ab、abab、ababab    |
  | {n,}  | 匹配至少 n 次 | (ab){2,}  | 匹配 2 个及以上连续的 ab |

### 其他元字符

- `[]` 范围内单字匹配
  - 匹配指定字符集和内的任何一个字符
    - `[]` 内加 `^` 可取反

  | 示例      | 说明                     |
  | --------- | ------------------------ |
  | [alc45_?] | 匹配 a、l、c、4、5、_、? |
  | [a-z]     | 匹配任意小写字母         |
  | [A-Z]     | 匹配任意大写字母         |
  | [0-9]     | 匹配任意数字             |
  | [a-Z0-9]  | 匹配任意字母或数字       |
  | [^A-Z]    | 匹配包括非大写字母的行   |
  | ^[^a-z]   | 匹配不以小写字母开头的行 |

- 整体及边界匹配

  | 类型 | 含义               | 示例       | 说明                                                 |
  | ---- | ------------------ | ---------- | ---------------------------------------------------- |
  | `()` | 组合为整体         | ab{1,3}    | 匹配 ab、abb、abbb                                   |
  | `\|` | 或者               | root\|bin  | 匹配 root、bin                                       |
  | `\b` | 单词边界           | \broot\b   | 匹配单词 root，不匹配 keroot、rooty、brooty 等字符串 |
  | `\<` | 单词的开头         | `\<th`     | 匹配以 th 开头的单词                                 |
  | `\>` | 单词的结束         | `\<root\>` | 作用与 `\broot\b` 相同                               |
  | `\w` | 字母、数字、下划线 | `\wa`      | 匹配 xa，不匹配 #a                                   |
  | `\s` | 匹配空白           | `\sa`      | 匹配 a，不匹配 xa                                    |
  | `\d` | 匹配数字           | `\da`      | 匹配 5a，不匹配 xa                                   |

  - `\` 为转义字符，可以为一些普通字符赋予特殊含义，或者将一些特殊字符变为普通字符

## sed 基本用法

- [sed 命令解析](#sed-命令解析)
  - sed 工具概述
  - 命令格式解析
  - 基本的处理动作
- [常见处理操作示例](#常见处理操作示例)
  - 输出文本
  - 删除文本
  - 替换文本
- [sed 应用案例](#sed-应用案例)
  - 修改 IP 配置
  - 修改网站根目录
  - 使用 sed 脚本

### sed 命令解析

- Stream EDitor，流式编辑器
  - ==非交互式==对文本进行增、删、改、查等操作
  - ==逐行处理==，并将结果输出到屏幕
- 主要用法
  - 格式1：`前置命令 | sed [选项] '条件指令'`
  - 格式2：`sed [选项] '条件指令' 文件...`
- 常见命令==选项==
  - `-n` `--quiet` `--silent`：屏蔽默认输出
  - `-i[SUFFIX]` `--in-place[=SUFFIX]`：修改文件内容
  - `-E` `-r` `--regexp-extended`：启用扩展的正则表达式
- ==条件==,可以是 `行号` 或 `/正则/`
  - 行号可以使用单个数字表示单行
  - 或者 `3,5` 表示连续的多行
  - 省略条件，则默认逐行处理全部文本
  - 匹配正则时，需要使用 `/表达式/`
- 常用动作指令
  
  | 操作符 | 用途       | 指令示例                                     |
  | ------ | ---------- | -------------------------------------------- |
  | `p`    | 打印行     | `2,4p` `2p;4p` `1~2p`                        |
  | `d`    | 删除行     | `2,4d`                                       |
  | `s`    | 字符串替换 | `s/old/new/` `s/old/new/3` `s/old/new/g`[^1] |

### 常见处理操作示例

- 输出文本
  
  | 示例                     | 解析                           |
  | ------------------------ | ------------------------------ |
  | `sed -n 'p' a.txt`       | 输出所有行，等同于 `cat a.txt` |
  | `sed -n '4p' a.txt`      | 输出第 4 行                    |
  | `sed -n '4,7p' a.txt`    | 输出输出第 4**~**7 行          |
  | `sed -n '/^bin/p' a.txt` | 输出以 bin 开头的行            |
  | `sed -n '$=' a.txt`      | 输出文件的行数                 |

- 删除文本

  | 示例[^2]                  | 解析                                  |
  | ------------------------- | ------------------------------------- |
  | `sed '3,5d' a.txt`        | 删除第 3~5 行                         |
  | `sed '/xml/d' a.txt`      | 删除所有包含 xml 的行                 |
  | `sed '/xml/!d' a.txt`     | 删除不包含 xml 的行，`!` 符号表示取反 |
  | `sed '/^install/d' a.txt` | 删除以 install 开头的行               |
  | `sed '$d' a.txt`          | 删除文件的最后一行                    |
  | `sed '/^$/d' a.txt`       | 删除所有空行                          |

[^2]:此例中只作输出，不更改原文件（若需要更改，应添加选项 `-i`）

- 替换文本
  
  | 示例[^2]                  | 解析                           |
  | ------------------------- | ------------------------------ |
  | `sed 's/xml/XML/' a.txt`  | 将每行中第一个 xml 替换为 XML  |
  | `sed 's/xml/XML/3' a.txt` | 将每行中第 3 个 xml 替换为 XML |
  | `sed 's/xml/XML/g' a.txt` | 将所有的 xml 替换为 XML        |
  | `sed 's/xml//' a.txt`     | 将所有的 xml 都删除            |
  | `sed '4,7s/^/#/' a.txt`   | 将第 4~7 行注释掉              |
  | `sed 's/#an/an/' a.txt`   | 解除以 #an 开头的行的注释      |

### sed 应用案例

#### 修改 IP 配置

- 修改虚拟机网卡配置文件（假设网卡名为 eth0）

  ```bash
  grep ^IPADDR /etc/sysconfig/network-scripts/ifcfg-eth0

  sed -ri '/^IPADDR/s/([0-9]{1,3}\.){3}([0-9]{1,3})/ 172.16.0.\2/p'
  ```

## sed 文本块处理
